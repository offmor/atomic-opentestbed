#!/usr/bin/env python

import sys
import os
import time
import serial
from nrfutil import DFU, DfuTransportSerial

# 设置固件文件路径和串行端口
firmware_path = 'd/HuaweiMoveData/Users/高英皓/Desktop/custom/dfu_test.zip'
serial_port = 'COM14'
baudrate = 115200

# 定义一些常量
QUIET = 5

def mdebug(level, message, attr='\n'):
    if QUIET >= level:
        print(message, end=attr, file=sys.stderr)

def main():
    # 检查固件文件是否存在
    if not os.path.exists(firmware_path):
        print(f"Firmware file not found: {firmware_path}")
        sys.exit(1)

    # 初始化串行接口
    try:
        transport = DfuTransportSerial.DfuTransportSerial(serial_port, baudrate)
    except Exception as e:
        print(f"Failed to open serial port {serial_port}: {e}")
        sys.exit(1)

    # 创建 DFU 对象
    dfu = DFU.DFU(transport)

    # 加载固件
    try:
        dfu.open(firmware_path)
    except Exception as e:
        print(f"Failed to load firmware from {firmware_path}: {e}")
        sys.exit(1)

    # 启动 DFU 流程
    try:
        dfu.dfu_send_images()
        print("Firmware update completed successfully.")
    except Exception as e:
        print(f"Firmware update failed: {e}")
        sys.exit(1)

    # 关闭串行接口
    transport.close()

if __name__ == '__main__':
    main()